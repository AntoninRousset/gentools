#!/bin/sh

set -eu

get_matcher() {
	if [ $# -eq 0 ]
	then
		return
	fi

	out="($1"
	while [ $# -gt 1 ]
	do
		out="$out|$1"
		shift
	done
	echo "$out)"
}

readonly MATCH="$(get_matcher "$@")"

qlop_arg='-r'
if ! qlop $qlop_arg >/dev/null 2>&1
then
	qlop_arg='-c'
fi

while pgrep --list-full emerge | grep -q python
do
	qlop $qlop_arg | awk "/^ \* .*$MATCH.*$/ {print \$2}" | head -n1 | while read pkg
	do
		echo ">> ${pkg}"
		tail --follow=name -n0 "/var/tmp/portage/${pkg}/temp/build.log" 2>/dev/null || :
	done
done
